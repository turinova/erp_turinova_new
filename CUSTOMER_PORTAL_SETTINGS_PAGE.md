# Customer Portal - Settings Page Implementation

## üéØ Overview
Created a comprehensive settings page where customers can edit their profile information, billing details, company selection, and change their password - matching the main app's `/company` page design exactly.

---

## üìÅ Files Created

### 1. **Server Component**
- **Path**: `/customer-portal/app/(dashboard)/settings/page.tsx`
- **Type**: Server-side rendered (SSR)
- **Purpose**: Fetches customer data and companies on the server, passes to client component

**Key Features**:
- Fetches current user from Supabase Auth
- Fetches `portal_customers` record by user ID
- Fetches all active companies for dropdown
- Includes loading skeleton
- Error handling for missing data

### 2. **Client Component**
- **Path**: `/customer-portal/app/(dashboard)/settings/SettingsClient.tsx`
- **Type**: Client component
- **Purpose**: Interactive form for editing customer settings

**Layout** (matches main app `/company` page exactly):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Breadcrumbs: Kezd≈ëlap > Be√°ll√≠t√°sok    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Be√°ll√≠t√°sok szerkeszt√©se    [Ment√©s]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Alapadatok                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ N√©v (editable)                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ E-mail (read-only, filled)        ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Telefonsz√°m (editable, formatted) ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Sz√°ml√°z√°si adatok                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Sz√°ml√°z√°si n√©v                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Orsz√°g                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ V√°ros, Ir√°ny√≠t√≥sz√°m               ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Utca, H√°zsz√°m                     ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Ad√≥- √©s nyilv√°ntart√°si adatok       ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Ad√≥sz√°m (auto-formatted)          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ C√©gjegyz√©ksz√°m (auto-formatted)   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ V√°llalat √©s be√°ll√≠t√°sok             ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Kiv√°lasztott v√°llalat (dropdown)  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ SMS √©rtes√≠t√©sek (toggle switch)   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Metaadatok                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ L√©trehozva (read-only)            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Utols√≥ m√≥dos√≠t√°s (read-only)      ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Jelsz√≥ megv√°ltoztat√°sa              ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Jelenlegi jelsz√≥ (with eye icon)  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ √öj jelsz√≥ (with eye icon)         ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ Jelsz√≥ meger≈ës√≠t√©se (with eye)    ‚îÇ ‚îÇ
‚îÇ ‚îÇ [Jelsz√≥ megv√°ltoztat√°sa] (warning)  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. **API Endpoints**

#### `/api/customer-settings/route.ts`
- **GET**: Fetch current logged-in customer's data
- **PATCH**: Update current logged-in customer's data
- Uses `supabase.auth.getUser()` to identify customer
- Updates `portal_customers` table

#### `/api/customer-settings/change-password/route.ts`
- **POST**: Change customer's password
- Verifies current password first
- Updates password via `supabase.auth.updateUser()`

### 4. **Navigation Menu**
- **Path**: `/customer-portal/data/navigation/verticalMenuData.tsx`
- **Updated**: Added "Be√°ll√≠t√°sok" menu item
- **Icon**: `ri-settings-3-line` with purple color (#8E44AD)

---

## üé® Design Features (Matching Main App)

### Visual Elements:
1. **Breadcrumbs** - Kezd≈ëlap > Be√°ll√≠t√°sok
2. **Page Header** - "Be√°ll√≠t√°sok szerkeszt√©se" with Save button on right
3. **Paper Cards** - Two separate cards (Settings + Password)
4. **Grid Layout** - Responsive 2-column grid (xs=12, md=6)
5. **Section Headers** - Typography variant="h6" with color="primary"
6. **Dividers** - After each section header
7. **Text Fields** - Full-width with proper labels
8. **Read-only Fields** - variant="filled" for email and metadata
9. **Required Fields** - Marked with asterisk via `required` prop
10. **Error Messages** - Helper text below fields
11. **Toast Notifications** - Success/error messages

### Auto-Formatting:
- **Phone Number**: `+36 30 999 2800` format
- **Tax Number**: `12345678-1-02` format
- **Company Reg**: `01-09-123456` format

### Validation:
- Name: Required
- Mobile: Required
- Tax number: Optional, but must match format if provided
- Company reg: Optional, but must match format if provided
- New password: Minimum 6 characters
- Password confirmation: Must match new password

---

## üìã Field Mapping

### From `portal_customers` Table:

| Field | Display Name | Type | Editable | Section |
|-------|-------------|------|----------|---------|
| `name` | N√©v | Text | ‚úÖ Yes | Alapadatok |
| `email` | E-mail | Email | ‚ùå Read-only | Alapadatok |
| `mobile` | Telefonsz√°m | Phone | ‚úÖ Yes | Alapadatok |
| `billing_name` | Sz√°ml√°z√°si n√©v | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_country` | Orsz√°g | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_city` | V√°ros | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_postal_code` | Ir√°ny√≠t√≥sz√°m | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_street` | Utca | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_house_number` | H√°zsz√°m | Text | ‚úÖ Yes | Sz√°ml√°z√°si adatok |
| `billing_tax_number` | Ad√≥sz√°m | Text | ‚úÖ Yes | Ad√≥ adatok |
| `billing_company_reg_number` | C√©gjegyz√©ksz√°m | Text | ‚úÖ Yes | Ad√≥ adatok |
| `selected_company_id` | Kiv√°lasztott v√°llalat | Dropdown | ‚úÖ Yes | V√°llalat |
| `sms_notification` | SMS √©rtes√≠t√©sek | Switch | ‚úÖ Yes | V√°llalat |
| `discount_percent` | - | - | üö´ Hidden | - |
| `created_at` | L√©trehozva | Date | ‚ùå Read-only | Metaadatok |
| `updated_at` | Utols√≥ m√≥dos√≠t√°s | Date | ‚ùå Read-only | Metaadatok |

### Password Change (Separate Section):
- **Current Password** - Required, password field with visibility toggle
- **New Password** - Required, minimum 6 characters, with visibility toggle
- **Confirm Password** - Required, must match new password, with visibility toggle

---

## üîê API Flow

### Fetch Settings (GET):
```
1. User navigates to /settings
2. Server fetches auth user
3. Server fetches portal_customers record
4. Server fetches active companies
5. Data passed to SettingsClient
6. Form populated with current values
```

### Update Settings (PATCH):
```
1. User edits form fields
2. Client validates input
3. Client formats phone/tax/company reg numbers
4. Client sends PATCH to /api/customer-settings
5. Server verifies user authentication
6. Server updates portal_customers table
7. Server returns updated data
8. Client shows success toast
9. Form updated with fresh data
```

### Change Password (POST):
```
1. User enters current/new/confirm passwords
2. Client validates (required, length, match)
3. Client sends POST to /api/customer-settings/change-password
4. Server verifies current password via signInWithPassword
5. Server updates password via auth.updateUser()
6. Server returns success
7. Client clears password fields
8. Client shows success toast
```

---

## üéØ User Experience

### Navigation:
1. User clicks "Be√°ll√≠t√°sok" in menu
2. Page loads with all current data pre-filled
3. User edits any field
4. Auto-formatting happens on blur/change
5. User clicks "Ment√©s" button
6. Toast notification confirms save
7. Data refreshed from server

### Password Change:
1. User scrolls to "Jelsz√≥ megv√°ltoztat√°sa" section
2. Enters current password
3. Enters new password (min 6 chars)
4. Confirms new password
5. Clicks "Jelsz√≥ megv√°ltoztat√°sa" button
6. System verifies current password
7. System updates to new password
8. Fields cleared
9. Toast notification confirms change

---

## üîí Security Features

1. **Authentication Required**: Middleware checks session before page load
2. **User Verification**: API endpoints verify user via `auth.getUser()`
3. **Email Immutable**: Email cannot be changed (read-only field)
4. **Password Verification**: Current password verified before change
5. **No User ID Exposure**: API uses authenticated user's ID from session
6. **Auto-timestamps**: `updated_at` automatically updated on save

---

## üìä Data Flow Diagram

```
Customer Portal Settings Page
‚îÇ
‚îú‚îÄ‚îÄ Server Side (page.tsx)
‚îÇ   ‚îú‚îÄ‚îÄ createClient() ‚Üí Get auth user
‚îÇ   ‚îú‚îÄ‚îÄ Fetch portal_customers by user.id
‚îÇ   ‚îú‚îÄ‚îÄ Fetch active companies
‚îÇ   ‚îî‚îÄ‚îÄ Pass to SettingsClient
‚îÇ
‚îú‚îÄ‚îÄ Client Side (SettingsClient.tsx)
‚îÇ   ‚îú‚îÄ‚îÄ Display form with current data
‚îÇ   ‚îú‚îÄ‚îÄ Handle input changes
‚îÇ   ‚îú‚îÄ‚îÄ Auto-format phone/tax/company numbers
‚îÇ   ‚îú‚îÄ‚îÄ Validate on save
‚îÇ   ‚îî‚îÄ‚îÄ Submit to API
‚îÇ
‚îî‚îÄ‚îÄ API Routes
    ‚îú‚îÄ‚îÄ GET /api/customer-settings
    ‚îÇ   ‚îî‚îÄ‚îÄ Return customer data for auth user
    ‚îú‚îÄ‚îÄ PATCH /api/customer-settings
    ‚îÇ   ‚îî‚îÄ‚îÄ Update customer data for auth user
    ‚îî‚îÄ‚îÄ POST /api/customer-settings/change-password
        ‚îî‚îÄ‚îÄ Verify current + update to new password
```

---

## ‚úÖ Testing Checklist

- [ ] Navigate to http://localhost:3001/settings (after login)
- [ ] Verify all fields populated with current data
- [ ] Email field is read-only (filled variant)
- [ ] Edit name and save - should update successfully
- [ ] Edit mobile number - should auto-format
- [ ] Edit billing fields - should save
- [ ] Edit tax number - should auto-format (12345678-1-02)
- [ ] Edit company reg - should auto-format (01-09-123456)
- [ ] Change selected company - should update
- [ ] Toggle SMS notification - should update
- [ ] Change password with correct current password - should succeed
- [ ] Change password with wrong current password - should fail
- [ ] New password < 6 chars - should show error
- [ ] Passwords don't match - should show error
- [ ] Check created_at and updated_at are read-only
- [ ] Save button shows "Ment√©s..." while saving
- [ ] Toast notifications appear for success/error
- [ ] Breadcrumbs navigate back to Kezd≈ëlap

---

## üéâ Summary

The settings page is now complete and matches the main app's `/company` page design exactly:
- ‚úÖ Same layout structure
- ‚úÖ Same Paper cards
- ‚úÖ Same Grid spacing
- ‚úÖ Same section headers
- ‚úÖ Same input field styling
- ‚úÖ Same breadcrumbs
- ‚úÖ Same save button placement
- ‚úÖ Same validation logic
- ‚úÖ Same auto-formatting
- ‚úÖ Plus password change functionality

**Ready for testing!** üöÄ

